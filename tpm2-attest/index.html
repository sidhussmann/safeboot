
<!doctype html>
<html lang="en" class="no-js">
  <head>
    

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Debian package to enable UEFI SecureBoot, enroll your own hardware backed platform key, sign the kernel and initrd, decrypt the disk with the TPM, and enable system integrity protection with dmverity">
      
      
      
        <link rel="canonical" href="https://safeboot.dev/tpm2-attest/">
      
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.4">
    
<!--
 fill in the opengraph meta tags, with defaults from the site config
 or values in the yaml metadata for the specific page (summary and image).
-->
<meta property="og:title"
      content="tpm2-attest subcommands">
<meta property="og:site_name" content="safeboot">
<meta property="og:url" content="https://safeboot.dev/tpm2-attest/">
<meta property="og:description"
	content="Debian package to enable UEFI SecureBoot, enroll your own hardware backed platform key, sign the kernel and initrd, decrypt the disk with the TPM, and enable system integrity protection with dmverity">
<meta property="og:image"
      content="https://safeboot.dev/images/logo.png">

    
      
        <title>tpm2-attest subcommands - safeboot</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.358818c7.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f0267088.min.css">
        
      
    
    
    
       <!-- Load fonts from Google -->
       
         
         <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
         <link rel="stylesheet" type="text/css"
             href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:300,400,400i,700%7CIBM+Plex+Sans:500,600,700%7CIBM+Plex+Mono&display=fallback" />
         <style>
           body, input {
             font-family: "IBM Plex Serif", "Helvetica Neue",
               Helvetica, Arial, sans-serif;
           }
           pre, code, kbd {
             font-family: "IBM Plex Mono", "Courier New",
               Courier, monospace;
           }
	   h1, h2, h3, h4, h5, h6 {
             font-family: "IBM Plex Sans", sans-serif;
	     font-weight: 700 !important;
           }
         </style>
       
     
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tpm2-attest-subcommands" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://safeboot.dev/" title="safeboot" class="md-header-nav__button md-logo" aria-label="safeboot">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            safeboot
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              tpm2-attest subcommands
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/osresearch/safeboot/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://safeboot.dev/" title="safeboot" class="md-nav__button md-logo" aria-label="safeboot">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    safeboot
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/osresearch/safeboot/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../install/" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../faq/" class="md-nav__link">
      Frequently Asked Questions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../threats/" class="md-nav__link">
      Threat Model
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../attestation/" class="md-nav__link">
      Remote Attestation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../chain-of-trust/" class="md-nav__link">
      Chain of Trust
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../safeboot/" class="md-nav__link">
      safeboot subcommands
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        tpm2-attest subcommands
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      tpm2-attest subcommands
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quote" class="md-nav__link">
    quote
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify" class="md-nav__link">
    verify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eventlog-verify" class="md-nav__link">
    eventlog-verify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ek-verify" class="md-nav__link">
    ek-verify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quote-verify" class="md-nav__link">
    quote-verify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#seal" class="md-nav__link">
    seal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unseal" class="md-nav__link">
    unseal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-and-seal" class="md-nav__link">
    verify-and-seal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ek-sign" class="md-nav__link">
    ek-sign
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quote" class="md-nav__link">
    quote
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify" class="md-nav__link">
    verify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eventlog-verify" class="md-nav__link">
    eventlog-verify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ek-verify" class="md-nav__link">
    ek-verify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quote-verify" class="md-nav__link">
    quote-verify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#seal" class="md-nav__link">
    seal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unseal" class="md-nav__link">
    unseal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-and-seal" class="md-nav__link">
    verify-and-seal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ek-sign" class="md-nav__link">
    ek-sign
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="tpm2-attest-subcommands">tpm2-attest subcommands</h1>
<p>Usage: <code>tpm2-attest subcommand [options...]</code></p>
<p>For more information see: <a href="https://safeboot.dev/attestation/">https://safeboot.dev/attestation/</a></p>
<h2 id="quote">quote</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>tpm2-attest quote [nonce [pcrs,...]] &gt; quote.tgz
scp quote.tgz ...
</code></pre></div>
After contacting the remote attestation server to receive the
nonce, the machine will generate the endorsement key,
endorsement cert, a one-time attestation key, and a signed quote
for the PCRs using that nonce.</p>
<p>This will result in two output files, <code>quote.tgz</code> to be sent to
the remote side, and <code>ak.ctx</code> that is to remain on this machine
for decrypting the return result from the remote attestation server.</p>
<h2 id="verify">verify</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>tpm2-attest verify quote.tgz [good-pcrs.txt [nonce [ca-path]]]
</code></pre></div></p>
<p>This will validate that the quote was signed with the attestation key
with the provided nonce, and verify that the endorsement key from a valid
TPM.</p>
<p>If the <code>nonce</code> is not specified, the one in the quote file will be used,
although this opens up the possibility of a replay attack.</p>
<p>If the <code>ca-path</code> is not specified, the system one will be used.</p>
<ul>
<li>TODO: verify event log</li>
</ul>
<h2 id="eventlog-verify">eventlog-verify</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>tpm2-attest eventlog-verify quote.tgz [good-pcrs.txt]
</code></pre></div></p>
<p>This will verify that the PCRs included in the quote match the
TPM event log, and if <code>good-prcs.txt</code> are passed in that they
match those as well.</p>
<h2 id="ek-verify">ek-verify</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>tpm2-attest ek-verify quote.tgz ca-path
</code></pre></div></p>
<p>This will validate that the endorsement key came from a valid TPM.</p>
<p>The TPM endorsement key is signed by the manufacturer OEM key, which is
in turn signed by a trusted root CA.  Before trusting an attestation it is
necessary to validate this chain of signatures to ensure that it came
from a legitimate TPM, otherwise an attacker could send a quote that
has a fake key and decrypt the message in software.</p>
<p>The <code>ca-path</code> should contain a file named <code>roots.pem</code> with the trusted
root keys and have the hash symlinks created by <code>c_rehash</code>.</p>
<ul>
<li>TODO: check parameters of attestation key.</li>
</ul>
<h2 id="quote-verify">quote-verify</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>tpm2-attest quote-verify quote.tgz [nonce]
</code></pre></div></p>
<p>This command checks that the quote includes the given nonce and
was signed by the public attestation key (AK) in the quote file.
This also check the attributes of the AK to ensure that it has
the correct bits set (<code>fixedtpm</code>, <code>stclear</code>, etc).
NOTE: This does not verify that the AK came from a valid TPM.
See <code>tpm2-attest verify</code> for the full validation.</p>
<p>If the <code>nonce</code> is not specified on the command line, the one in the
quote file will be used.  Note that this is a potential for a replay
attack -- the remote attestation server should keep track of which
nonce it used for this quote so that it can verify that the quote
is actually live.</p>
<h2 id="seal">seal</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>echo secret | tpm2-attest seal quote.tgz [nonce] &gt; cipher.bin
</code></pre></div></p>
<p>After a attested quote has been validated, an encrypted reply is sent to
the machine with a sealed secret, encrypted with that machines
endorsment key (<code>ek.crt</code>), with the name of the attestation key
used to sign the quote.  The TPM will not decrypt the sealed
message unless the attestation key was one that it generated.</p>
<p>The <code>cipher.bin</code> file should be sent back to the device being attested;
it can then run <code>tpm2-attest unseal ak.ctx &lt; cipher.bin &gt; secret.txt</code>
to extract the sealed secret.</p>
<h2 id="unseal">unseal</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>cat cipher.bin | tpm2-attest unseal ak.ctx  &gt; secret.txt
</code></pre></div></p>
<p>When the remote attestation has been successful, the remote machine will
reply with an encrypted blob that is only unsealable by this TPM
if and only if the EK matches and the AK is one that it generated.</p>
<h2 id="verify-and-seal">verify-and-seal</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>tpm2-attest verify-and-seal quote.tgz [nonce [pcrs]] &lt; secret.txt &gt; cipher.bin
</code></pre></div></p>
<p>If the <code>nonce</code> is not specified on the command line, the one in the
quote file will be used.  Note that this is a potential for a replay
attack -- the remote attestation server should keep track of which
nonce it used for this quote so that it can verify that the quote
is actually live.</p>
<h2 id="ek-sign">ek-sign</h2>
<p>Usage:
<div class="highlight"><pre><span></span><code>tpm2-attest ek-sign &lt; ek.pem &gt; ek.crt [/CN=device-name/]
</code></pre></div></p>
<p>Some TPMs do not include manufacturer signed endorsement key
certificates, so it is necessary to extract the EK and sign it
with a trusted key.  This will produce <code>ek.crt</code>, signed with
the safeboot key.  The signing operation can be done out-of-band
on a different machine.</p>
<p>For Google Cloud ShieldedVM machines see:
<a href="https://cloud.google.com/security/shielded-cloud/retrieving-endorsement-key">https://cloud.google.com/security/shielded-cloud/retrieving-endorsement-key</a></p>
<p>Usually the EK public components can be extracted from the TPM, signed,
and the resulting signed <code>ek.crt</code> can be stored back into the TPM nvram.
Note that this will erase an existing OEM cert if you have one!</p>
<div class="highlight"><pre><span></span><code>tpm2 createek -c /dev/null -f PEM -u ek.pem
tpm2-attest ek-sign &lt; ek.pem &gt; ek.crt /CN=device/OU=example.org/
tpm2 nvdefine -s 1500 0x1c00002
tpm2 nvwrite -i ek.crt 0x1c00002
</code></pre></div>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 7, 2020</span>
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../safeboot/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                safeboot subcommands
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../assets/javascripts/bundle.b3a72adc.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>